// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id                    String   @id @default(uuid())
  patientCode           String   @unique
  name                  String
  nameKana              String?
  gender                String   // '男' | '女' | 'Male' | 'Female'
  dateOfBirth           String
  age                   Int
  medicalRecordNumber   String
  
  // Contact Information
  phone                 String?
  email                 String?
  address               String?
  
  // Medical Information
  bloodType             String?
  allergies             Json?    // string[]
  conditions            Json?    // string[]
  height                Float?   // cm
  weight                Float?   // kg
  bmi                   Float?
  
  // Admission Information
  department            String?
  bed                   String?
  admissionDate         String?
  dischargeDate         String?
  admissionDiagnosis    String?
  dpcDiagnosis          String?
  dpcPeriod             String?
  
  // Staff Information
  wardAttendingPhysician    String?
  resident                 String?
  attendingPhysicianA      String?
  attendingPhysicianB      String?
  outpatientAttendingPhysician String?
  attendingNS              String?
  
  // Status and Flags
  specialNotes          String?  @db.Text
  status                String?
  plan                  Boolean? @default(false)
  nutrition             String?
  path                  Boolean? @default(false)
  clinicalPath          Boolean? @default(false)
  nst                   Boolean? @default(false)
  rst                   Boolean? @default(false)
  
  // Additional Medical Information
  chiefComplaint        String?  @db.Text
  smokingHistory        String?  @db.Text
  drinkingHistory       String?  @db.Text
  
  // Summary
  summary               String?  @db.Text
  
  // Relations
  visits                Visit[]
  medicalRecords        MedicalRecord[]
  monitoringRecords     MonitoringRecord[]
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([patientCode])
  @@index([medicalRecordNumber])
  @@map("patients")
}

model Visit {
  id          String   @id @default(uuid())
  patientId   String
  visitId     String   // Original ID from JSON for reference
  date        String
  department  String
  type        String   // '外来' | '入院' | 'Outpatient' | 'Inpatient'
  diagnosis   String?
  notes       String?  @db.Text
  physician   String?
  
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([patientId])
  @@index([date])
  @@map("visits")
}

model MedicalRecord {
  id                String   @id @default(uuid())
  patientId         String
  recordId          String   // Original ID from JSON for reference
  date              String
  type              String   // '初診' | '再診' | '外来受診' | '入院診療録'
  visitType         String?  // '外来' | '入院'
  dayOfStay         Int?
  
  // Progress note (unified SOAP format)
  progressNote      String?  @db.Text

  // Author information
  authorId          String?  // User ID of the author
  authorRole        String?  // Role of the author at time of writing
  authorName        String?  // Full name of the author

  // Additional fields stored as JSON
  laboratoryResults Json?    // { [key: string]: string | number }
  imagingResults    String?  @db.Text

  medications       Json?    // { name: string, dosage: string, frequency: string, duration?: string }[]

  physician         String?
  notes             String?  @db.Text
  
  patient           Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  deletedAt         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([patientId])
  @@index([date])
  @@index([deletedAt])
  @@map("medical_records")
}

model MonitoringRecord {
  id                    String   @id @default(uuid())
  patientId             String
  recordId              String
  date                  DateTime
  
  // Vital Signs (as separate columns for query performance)
  temperature           Float?
  systolicBloodPressure Float?
  diastolicBloodPressure Float?
  heartRate             Float?
  spO2                  Float?
  oxygenFlow            Float?
  
  // Monitoring Data
  weight                Float?
  foodIntakeMorning     String?
  foodIntakeLunch       String?
  foodIntakeEvening     String?
  urineOutput           Float?
  bowelMovementCount    Int?
  urinationCount        Int?
  drainOutput           Float?
  other                 String?  @db.Text
  
  patient               Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  deletedAt             DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([patientId])
  @@index([date])
  @@index([deletedAt])
  @@map("monitoring_records")
}

model RecordHistory {
  id               String   @id @default(uuid())
  recordType       String   // 'medical_record' or 'monitoring_record'
  recordId         String   // Current UUID of the record
  originalRecordId String   // Original recordId from JSON
  action           String   // 'created', 'updated', 'deleted'
  previousData     Json?
  newData          Json?
  changedBy        String?  // User ID
  changedAt        DateTime @default(now())
  reason           String?
  createdAt        DateTime @default(now())

  @@index([recordType, recordId])
  @@index([originalRecordId])
  @@index([changedAt])
  @@map("record_history")
}

model AppSettings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_settings")
}

model User {
  id                    String    @id @default(uuid())
  username              String    @unique
  email                 String    @unique
  passwordHash          String

  // User Profile
  fullName              String
  role                  UserRole  @default(NURSE)
  department            String?
  licenseNumber         String?   // Medical license number

  // Security & Status
  isAdmin               Boolean   @default(false)  // Administrator permissions
  isActive              Boolean   @default(true)
  isLocked              Boolean   @default(false)
  failedLoginAttempts   Int       @default(0)
  lastLoginAt           DateTime?
  lastLoginIp           String?

  // Password Management
  passwordResetToken    String?   @unique
  passwordResetExpiry   DateTime?
  mustChangePassword    Boolean   @default(true)  // Force password change on first login

  // Audit
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             String?

  // Relations
  auditLogs             AuditLog[]

  @@index([email])
  @@index([username])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

enum UserRole {
  DOCTOR             // Physician - full patient access
  NURSE              // Nursing staff - patient care & monitoring
  PHARMACIST         // Pharmacy staff - medication access
  MEDICAL_CLERK      // Medical records clerk - data entry
}

model AuditLog {
  id            String   @id @default(uuid())
  userId        String?
  username      String   // Store username for deleted users
  action        String   // LOGIN, LOGOUT, CREATE_USER, UPDATE_USER, DELETE_USER, etc.
  resourceType  String?  // USER, PATIENT, MEDICAL_RECORD, etc.
  resourceId    String?
  details       Json?    // Additional context
  ipAddress     String?
  userAgent     String?  @db.Text
  success       Boolean  @default(true)
  errorMessage  String?  @db.Text
  createdAt     DateTime @default(now())

  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}
